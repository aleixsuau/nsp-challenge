<div *ngIf="vm$ | async as vm"
  data-testid="departments-list"
>
  <div class="mb-6 flex justify-content-between align-items-center"
    data-testid="department-list-header">
    <h2 class="text-2xl uppercase" data-testid="department-list-title">
      Departments list
    </h2>
    <p-button label="Add Department"
      (click)="openDepartmentFormDialog($event);"
      data-testid="department-list-add-button">      
    </p-button>
  </div>
  <div data-testid="department-list-departments">
    <p-accordion
      *ngFor="let department of vm.departments;"
      class="block mb-4"
      data-testid="department-list-department"
      (click)="getDepartmentUsers(department);"
    >
      <p-accordionTab data-testid="department-list-block">
        <ng-template pTemplate="header">
          <div class="flex-grow-1 flex gap-4 align-items-center">
            <h4 class="mx-3 uppercase" data-testid="department-name">
              {{department.name}}
            </h4>
            <p-badge [value]="'' + department?.users?.length"></p-badge>
            <div class="ml-auto" data-testid="department-list-department-buttons">
              <p-button
                label="Edit"
                class="mr-2"
                icon="pi pi-check"
                (click)="openDepartmentFormDialog($event, department);"
                data-testid="department-list-edit-button"
              >
              </p-button>
              <p-button
                label="Delete"
                icon="pi pi-check"
                (click)="deleteDepartment($event, department);"
                data-testid="department-list-delete-button"
              >
              </p-button>
            </div>            
          </div>
        </ng-template>
        <p-table 
          [value]="vm.users[department.id]"
          [tableStyle]="{ 'min-width': '50rem' }"
          data-testid="department-users-table"
          *ngIf="vm.users[department.id]; else usersSpinner;"
        >
          <ng-template pTemplate="header">
            <tr>
              <th>id</th>
              <th>name</th>
              <th>email</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-user>
            <tr data-testid="department-users-table-row">
              <td data-testid="user-id">{{ user.id }}</td>
              <td data-testid="user-name">{{ user.name }}</td>
              <td data-testid="user-email">{{ user.email }}</td>
            </tr>
          </ng-template>
        </p-table>
        <ng-template #usersSpinner>
          <div class="flex justify-content-center">
            <p-progressSpinner styleClass="w-4rem h-4rem"></p-progressSpinner>
          </div>
        </ng-template>
      </p-accordionTab>
    </p-accordion>
  </div>
</div>
